# Lab Setup

For the malware analysis Lab Setup, we will be using 2 VM's :

- Flare VM  -  Windows 10 Enterprise Evaluation
- REMnux   -  Linux Distro


## Download and Setup

### Flare VM

A base Windows Virtual Machine is used on which Flare VM created by the Mandiant Security Team is installed. It is a fully customizable, Windows based Security Distribution for Malware Analysis, Incident Response and Penetration Testing.

Windows 10  - https://info.microsoft.com/ww-landing-windows-10-enterprise.html
Flare VM          - https://github.com/mandiant/flare-vm


#### Installation Steps

- Download the Windows 10 Enterpise Evaluation iso from the above link and load it onto any of your favourite Virtualization software. I have used [VMware](https://customerconnect.vmware.com/en/downloads/info/slug/desktop_end_user_computing/vmware_workstation_pro/16_0) Workstation for my lab setup.

> Hard Disk   :  60GB
> RAM              :  Atleast 2 GB

- Follow through the setup of Windows VM and install VMware tools.

> 1. **Disconnect the floppy disk** in settings before starting install to prevent errors, **do not delete it though**
> 2. You can manually download and install vmware tools from their site if the auto install does not work properly.

- Once installed, download [Chrome](https://www.google.com/intl/en_in/chrome/) Browser and disable Windows Defender.
- Download the [install.ps1](https://raw.githubusercontent.com/mandiant/flare-vm/master/install.ps1) script to your desktop.
- Now open a new Powershell prompt as Administrator and navigate to your desktop.
- Run these commands for automatic installation of Flare VM
```powershell
Unblock-File .\install.ps1

Set-ExecutionPolicy Unrestricted

.\install.ps1
```

###### The whole installation process takes about 2 hours approximately. The system will automatically restart and finish the installation on its own, DO NOT STOP OR INTERRUPT the process.

After the installation is complete, you will be presented with the desktop with all the Flare VM tools installed and configured. 

![Pasted image 20220906205835](PMAT-Attachments/Pasted%20image%2020220906205835.png)

At this step, take a snapshot of the Virtual Machine. 

---
**NOTE**

If any program does not get installed due to a hash sum mismatch or any other error.
You can run the command in cmder as Administrator -

``` 
cinst <program-name> --ignore-checksums
```

---


### REMnux

REMnux is a Linux toolkit designed for Reverse Engineering and Malware analysis. It contains a curated collection of free open-source tools. 

- REMnux VM Download - https://docs.remnux.org/install-distro/get-virtual-appliance


#### Installation Steps

- Download the General OVA for VMware Workstation.
- Import this into your VMware Workstation by right-clicking on the downloaded file and opening it with VMware.
- Click Start to start the Virtual Machine.
- Take a base snapshot

![Pasted image 20220906211406](PMAT-Attachments/Pasted%20image%2020220906211406.png)



## Network Setup

Create a new Host only Network Adapter for Malware Analysis.

![Pasted image 20220906211638](PMAT-Attachments/Pasted%20image%2020220906211638.png)

DHCP Settings

![Pasted image 20220906211709](PMAT-Attachments/Pasted%20image%2020220906211709.png)


Now connect both the Virtual machines to the same Network Adapter, in this case, vmnet0.


## inetsim

Inetsim is a network stimulation software that can stimulate common internet services. This becomes essential for malware sandboxing and analysis. 

To set this up,  go to the Network Connection Settings in the Flare VM and change the DNS to point to the IP of our REMnux machine.

![Pasted image 20220906213942](PMAT-Attachments/Pasted%20image%2020220906213942.png)

![Pasted image 20220906214003](PMAT-Attachments/Pasted%20image%2020220906214003.png)

![Pasted image 20220906214033](PMAT-Attachments/Pasted%20image%2020220906214033.png)

Now double click on the _Internet Protocol Version 4 (TCP/IPv4)_ and set the preferred DNS Server to point to our REMnux IP address.

![Pasted image 20220906214124](PMAT-Attachments/Pasted%20image%2020220906214124.png)


### Configuring inetsim

Open inetsim config file using a text editor.

![Pasted image 20220906214252](PMAT-Attachments/Pasted%20image%2020220906214252.png)

Uncomment the DNS service

![Pasted image 20220906214327](PMAT-Attachments/Pasted%20image%2020220906214327.png)

Scroll down and set the _DNS Default IP_ to point to the machine IP

![Pasted image 20220906214424](PMAT-Attachments/Pasted%20image%2020220906214424.png)

Save and exit the file

Now start inetsim 

![Pasted image 20220906214530](PMAT-Attachments/Pasted%20image%2020220906214530.png)

Now go to Flare VM and try access this IP Address

![Pasted image 20220906214617](PMAT-Attachments/Pasted%20image%2020220906214617.png)


This also works for **https**

![Pasted image 20220906214741](PMAT-Attachments/Pasted%20image%2020220906214741.png)

Now try any dns name

![Pasted image 20220906214907](PMAT-Attachments/Pasted%20image%2020220906214907.png)

![Pasted image 20220906214926](PMAT-Attachments/Pasted%20image%2020220906214926.png)


All queries give a **200 OK** and default to the stimulated page.

Now try adding any file extension to a random file.

![Pasted image 20220906215103](PMAT-Attachments/Pasted%20image%2020220906215103.png)

It automatically downloads an empty binary file of the same name.

![Pasted image 20220906215132](PMAT-Attachments/Pasted%20image%2020220906215132.png)

Try opening this file.

![Pasted image 20220906215150](PMAT-Attachments/Pasted%20image%2020220906215150.png)


This way inetsim stimulates internet service without actually exposing the sandboxed environment to the internet. This is good for malware analysis as some malwares only run when they can query a server or ping any server.
