ch__Binary Used__ : _putty.exe_

# Challenge

![Pasted image 20220912083905](PMAT-Attachments/Pasted%20image%2020220912083905.png)

# Static Analysis

## Hashes

| Hash Algorithm |                               Hash                               |
|:--------------:|:----------------------------------------------------------------:|
|      MD5       |                 334A10500FEB0F3444BF2E86AB2E76DA                 |
|     SHA256     | 0C82E654C09C8FD9FDF4899718EFA37670974C9EEC5A8FC18A167F93CEA6EE83 |

## Virus Total

![Pasted image 20220912085401](PMAT-Attachments/Pasted%20image%2020220912085401.png)

Virus total flags this as a Trojan.

## Floss 

![Pasted image 20220912084720](PMAT-Attachments/Pasted%20image%2020220912084720.png)

A bunch of Windows API being used by the binary.

![Pasted image 20220912084810](PMAT-Attachments/Pasted%20image%2020220912084810.png)

We can see a powershell command running with a hidden window. The payload is a base64 string.


## PEstudio

![Pasted image 20220912085615](PMAT-Attachments/Pasted%20image%2020220912085615.png)

![Pasted image 20220912085751](PMAT-Attachments/Pasted%20image%2020220912085751.png)

![Pasted image 20220912085912](PMAT-Attachments/Pasted%20image%2020220912085912.png)



## Base64 decoding of payload

![Pasted image 20220912092838](PMAT-Attachments/Pasted%20image%2020220912092838.png)

We see that it is a gzip compressed data.

![Pasted image 20220912093047](PMAT-Attachments/Pasted%20image%2020220912093047.png)

Opening the unzipped file

![Pasted image 20220912093158](PMAT-Attachments/Pasted%20image%2020220912093158.png)

We see that it calls for a reverse shell on the domain with the port 8443

![Pasted image 20220912093524](PMAT-Attachments/Pasted%20image%2020220912093524.png)

I found the same script from [this github page](https://github.com/davehardy20/PowerShell-Scripts/blob/master/Invoke-Powerfun.ps1).


# Dynamic Analysis

Running program without inetsim

![Pasted image 20220912090820](PMAT-Attachments/Pasted%20image%2020220912090820.png)

We see a PS_transcripts folder has emerged, meaning that a powershell script was run in the background. Just as suspected during our static analysis.

Opening the file and seeing through the logs

![Pasted image 20220912091107](PMAT-Attachments/Pasted%20image%2020220912091107.png)

We see the same command was run when we ran _putty.exe_ binary.


## Network Indicators


### Wireshark

![Pasted image 20220912091415](PMAT-Attachments/Pasted%20image%2020220912091415.png)

We see a DNS request made to _bonus2.corporatebonusapplication.local_

Let us add this to our _/etc/hosts_

![Pasted image 20220912091813](PMAT-Attachments/Pasted%20image%2020220912091813.png)


### TCPview

![Pasted image 20220912092313](PMAT-Attachments/Pasted%20image%2020220912092313.png)

Pausing in the right time, we can see this

![Pasted image 20220912094107](PMAT-Attachments/Pasted%20image%2020220912094107.png)



## Host based Indicators

Running the binary with procmon

>  **_Procmon Filter_**
> - Process name contains _puTTY_

Check the process tree
![Pasted image 20220912100408](PMAT-Attachments/Pasted%20image%2020220912100408.png)


Now add the parent PID to the filter and remove the previous filter.

>  **_Procmon Filter_**
> - Parent PID is _1784_

Filtering only network connections, we can see that the powershell script has tried to connect to our system

![Pasted image 20220912100003](PMAT-Attachments/Pasted%20image%2020220912100003.png)

Let us try to open a listener on port 8443

![Pasted image 20220912100849](PMAT-Attachments/Pasted%20image%2020220912100849.png)

We get a connection!! Let us try to run a command.

![Pasted image 20220912100945](PMAT-Attachments/Pasted%20image%2020220912100945.png)

But we also observe that the connection breaks as soon as a command is typed in!

This is because after the connection is established, the connection switches to ___https___ , hence the terminal is filled with gibberish and any command typed breaks the connection.

> We can try to use a metasploit listener with https to get a reverse shell


Final Process of the malware :
- Runs the regular putty binary
- Spawns a powershell in the background as a hidden windows
- Decodes a base64 encoded payload and then unzips it
- Runs the code which tries calling back to the listener on the domain and port 8443
- If listener is found
	- Connects with it
	- Switches communication to https
	- Gives a fully functional reverse shell
- else 
	- Exits the powershell and only runs the regular putty binary
