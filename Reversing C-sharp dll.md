# Reversing C# DLLs

__Dll used__ :  _Malware.cryptlib64.dll_


## Challenge

![[Attachments/Pasted image 20220920120401.png]]

## Reversing and analyzing the dll

We can use ___dnSpy___ to reverse the ___Intermediate Language___ back to its source code.

![[Attachments/Pasted image 20220920120642.png]]
 
![[Attachments/Pasted image 20220920120708.png]]

Analysis of the script : 
- A clear text password is hashed using the SHA256 algorithm and stored in the _passwordBytes_ variable.
- A long base64 string is first decoded from base64 and then decrypted using AES and passed on to the __MemoryStream__ from where it is passed on to the __StreamReader__.
- This is stored in the _contents_ variable.
- The data from the _contents_ variable is written to ___embed.xml___ in the __Public Folder__.
- A new base64 string is decoded and then stored in the _contents2_ variable.
- This data is written to ___embed.vbs___ file in _C:\\Users\\Public\\Documents\\embed.vbs_
- Next a registry key is created for persistence. The registry key is stored at __Software\\Microsoft\\Windows\\CurrentVersion\\Run__ , its value is the complete path to the ___embed.vbs___ file.


## Running the Dll

A dll needs to run inside the container of a program, we can use _rundll32_ with the program name to run this dll.

![[Attachments/Pasted image 20220920121643.png]]

We can see the files being written along with the new registry key.

![[Attachments/Pasted image 20220920121723.png]]

![[Attachments/Pasted image 20220920121744.png]]

![[Attachments/Pasted image 20220920121858.png]]


## Analyzing the newly created files

### embed.vbs

![[Attachments/Pasted image 20220920122001.png]]

We see that it creates a new shell and runs the ___embed.xml___ file.


### embed.xml

![[Attachments/Pasted image 20220920122142.png]]

![[Attachments/Pasted image 20220920122155.png]]

Analysis : 
- We can see a long base64 string which is decoded and deflated and then written to a variable called _ds_
- A lot of manual obfuscation has been added.
- The payload is loaded and executed using reflection into the memory.